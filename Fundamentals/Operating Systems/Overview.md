- OS runs in **kernel mode**, rest of software in **user mode**
	- Instructions that affect control of machine or do I/O use are forbidden to user mode programs

- Goals of OS
	- Provision of a clean interface for devs to interact with
	- Resource management
		- **Multiplexing** (sharing) resources in <u>time</u> and <u>space</u>
			- Time: different programs take turns using the resource
			- Space: Each program gets part of the resource 

- Simple PC Model
	- CPU, memory, I/O devices connected by system bus and communicates over it
	- **CPU**
		- **Basic cycle:** Fetch instruction from memory into registers, decode to determine type and operands, execute, loop
		- **Special registers**
			- **Program counter**: Contains memory address of next instruction to be fetched
			- **Stack pointer**: Points to top of current stack in memory. Stack contains one frame for each procedure that has been entered but not exited
			- **Program status word (PSW):** Contains condition code bits, CPU priority, mode, and various control bits
		- **Pipelines**: 
			- Fetch $\rightarrow$ Decode $\rightarrow$ Execute has separate units. When Fetch unit is fetching instruction `n`, decode could be decoding `n+1` and execute could be executing `n+2`
		- **Superscalar CPU**
			- Instead of Fetch $\rightarrow$ Decode $\rightarrow$ Execute in a sequential manner, pipelines speed up the whole cycle by separating fetch and decode and feeding them into a holding buffer, from which execute units then take
		- **Obtaining services from OS**
			- User program must make <u>system calls</u>, which executes the `TRAP` instruction to switch into kernel and activates OS
		- See multithreading/ hyperthreading
	
	- **Memory**
		- Consists of hierarchy of layers
			- **Registers**: 1ns, <1kB
				- Registers internal to CPU, just as fast as CPU
				- Storage usually 32x32 on 32 bits and vice versa for 64 bits
			- **Cache**: 2ns, 4MB
				- Contains most heavily used cache lines 
				- Divided into **cache lines**, typically 64 bytes, with addr 0 to 63 in cache line 1, 64 to 127 in cache line 2, ...
				- If required line in cache (cache hit), request is satisfied and no memory request is sent to main memory
				- New item typically entered on cache miss; cache line to use generated by using high-order bits of memory address referenced
			- **Main memory**: 10ns, 4-8GB
				- **Random access memory (RAM)**: 
				- **Read only memory (ROM)**: non-volatile; Programmed at factory and cannot be changed afterwards
				- **EEPROM(Electrically Erasable PROM)/ Flash Memory**: non-volatile but can be erased and rewritten; flash memory intermediate in speed between RAM and disk
				- **Complementary Metal-oxide Semiconductor (CMOS)**: volatile; used to hold current time and date. CMOS memory and clock circuit are powered by small battery, so time is correctly updated even if computer unplugged; can also hold config params e.g. which disk to boot
			- **Magnetic disk**: 10ms, 1-4TB
				- 3 orders slower than RAM, 2 orders cheaper and larger
				- Refer to [[Disk Structure]]
				- **Virtual memory**: Mapping memory addresses on the fly to convert address program generated to physical address in RAM; done by part of CPU called Memory Management Unit (MMU)
	
	- **I/O Devices**
		- **Serial Advanced Technology Attachment (SATA)**: protocol defining how to transmit data between devices
		- **Device driver:** Software that communicates with device controller; Vast majority of drivers still run in kernel
			- 3 ways for driver to be loaded:
				1) Relink kernel with new driver and boot (older UNIX systems)
				2) Make an entry into an OS file telling OS that it needs driver and reboot. At boot time, OS finds and loads driver (Windows)
				3) OS accept and install new drivers without rebooting (More common now)
			- Every controller has a small number of registers to communicate
				- To activate controller, driver gets command from OS, then translates it into appropriate values to write on device register
				- Collection of all device registers called IO port space 
		- **I/O Operations**
			1) **Busy Waiting**: User program issues system call, kernel translates into procedure call to appropriate driver. Driver starts IO and sits in a tight loop continuously polling device to see if done. When IO done, driver puts data where is needed and return control to OS
			2) **Interrupt-based IO**: Driver starts device and ask it to give interrupt when done, then driver returns. OS blocks caller if needed and looks for other work. See [[Interrupts]]
			3) **Direct Memory Access:** Chip that can control flow of bits between memory and some controller without constant CPU intervention.
				1) CPU tells DMA chip how many bytes to transfer, device/ memory addresses involved and lets it go 
				2) When DMA done, it causes interrupt
				3) See [[Direct Memory Access]] for more
	- **Buses**
		- ![[Example Bus Architecture.png]]
		- **Peripheral Component Interconnect Express (PCIe) Bus:** 
			- Connection for high speed data transfer between components; Can transfer tens of GB/s 
			- Utilizes serial bus architecture as opposed to the older shared bus architecture and parallel bus architecture (PCI)
			- **Serial bus architecture:** Send all bits in a message through single connection known as lane (similar to network packet)
			- **Parallel bus architecture**: Send each word of data over multiple wires (Single 32 bit word sent over 32 parallel wires)
			- **Shared bus architecture:** Multiple devices uses same wire to transfer data
		- **Direct Media Interface (DMI) Bus:** Intel's proprietary link between CPU and Platform controller hub
		- **Universal Serial Bus (USB)**: For attaching slow IO devices
			- Centralized bus in which root device polls all IO devices every 1ms to see if there's traffic 
		- **Small Computer System Interface (SCSI):** high performance bus intended for fast devices needing considerable bandwidth; mostly found in servers and workstations and can run up to 640MB/s

Note: Difference between SATA and PCIe is that PCIe can use multiple lanes and is therefore faster